<!DOCTYPE html>
<html lang="pt-BR">
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin - Produtos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="../js/config.js"></script>
  <link rel="stylesheet" href="admin.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
  <div class="container my-4">
    <h1 class="mb-3">Painel Admin</h1>
    <div class="header-topo">
      <nav class="main-nav">
        <ul class="nav-list">
          <li><a href="../index.html">Sair</a></li>
        </ul>
      </nav>
    </div>

  <form id="form-produto" class="card p-3 mb-4 shadow-sm">
    <input type="hidden" name="id" />
    <div class="mb-2"><label class="form-label">Nome</label><input name="nome" required class="form-control" /></div>
    <div class="mb-2"><label class="form-label">Preço</label><input name="preco" type="number" step="0.01" required class="form-control" /></div>
    <div class="mb-2"><label class="form-label">Imagem (caminho)</label><input name="imagem" class="form-control" /></div>
    <div class="mb-2"><label class="form-label">Descrição</label><textarea name="descricao" class="form-control"></textarea></div>
    <div class="mb-3"><label class="form-label">Categoria</label><input name="categoria" class="form-control" /></div>
    <button type="submit" class="btn btn-primary me-2">Salvar</button>
    <button type="button" id="btn-cancel" style="display:none" class="btn btn-secondary">Cancelar</button>
  </form>

  <h2 class="mb-2">Lista de Produtos</h2>
  <div id="lista-admin" class="d-flex flex-column gap-2"></div>

  <script>
  const API = (typeof window.API_PRODUTOS !== 'undefined' ? window.API_PRODUTOS : `http://${window.location.hostname || 'localhost'}:3000/api/produtos`);

  async function carregarAdmin(filtro) {
    let url = API;
    if (filtro && filtro.trim() !== '') {
      const params = new URLSearchParams({ q: filtro.trim() });
      url = API + '?' + params.toString();
    }
    const res = await fetch(url);
    const produtos = await res.json();
    const lista = document.getElementById('lista-admin');
    if (!Array.isArray(produtos) || produtos.length === 0) {
      lista.innerHTML = '<p>Nenhum produto encontrado.</p>';
      return;
    }
    lista.innerHTML = produtos.map(p => `
      <div class="admin-item" data-id="${p.id}">
        <img src="../${p.imagem}" alt="${p.nome}" style="max-width:80px"/>
        <div class="info">
          <strong>${p.nome}</strong>
          <p>R$ ${Number(p.preco).toFixed(2)}</p>
        </div>
        <div class="acoes">
          <button onclick="verDetalhes(${p.id})">Detalhes</button>
          <button onclick="editar(${p.id})">Editar</button>
          <button onclick="excluir(${p.id})">Excluir</button>
        </div>
      </div>
    `).join('');
  }

  const formProduto = document.getElementById('form-produto');
  if (formProduto) {
    formProduto.addEventListener('submit', async (e) => {
      e.preventDefault();
      const f = e.target;
      const body = {
        nome: f.nome.value,
        preco: Number(f.preco.value),
        imagem: f.imagem.value,
        descricao: f.descricao.value,
        categoria: f.categoria.value
      };
      const id = f.id.value;
      if (id) {
        await fetch(`${API}/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      } else {
        await fetch(API, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      }
      f.reset();
      document.getElementById('btn-cancel').style.display = 'none';
      carregarAdmin(document.getElementById('buscaAdmin')?.value || '');
    });
  }

  async function excluir(id) {
    if (!confirm('Confirma exclusão?')) return;
    await fetch(`${API}/${id}`, { method: 'DELETE' });
    carregarAdmin(document.getElementById('buscaAdmin')?.value || '');
  }

  async function editar(id) {
    const res = await fetch(`${API}/${id}`);
    const p = await res.json();
    const f = document.getElementById('form-produto');
    f.id.value = p.id;
    f.nome.value = p.nome;
    f.preco.value = p.preco;
    f.imagem.value = p.imagem || '';
    f.descricao.value = p.descricao || '';
    f.categoria.value = p.categoria || '';
    document.getElementById('btn-cancel').style.display = 'inline-block';
    document.getElementById('btn-cancel').onclick = () => {
      f.reset();
      f.id.value = '';
      document.getElementById('btn-cancel').style.display = 'none';
    };
  }

  async function verDetalhes(id) {
    const res = await fetch(`${API}/${id}`);
    if (!res.ok) {
      alert('Produto não encontrado.');
      return;
    }
    const p = await res.json();
    alert(
      'ID: ' + p.id + '\n' +
      'Nome: ' + (p.nome || '') + '\n' +
      'Preço: R$ ' + Number(p.preco).toFixed(2) + '\n' +
      'Categoria: ' + (p.categoria || '') + '\n' +
      'Descrição: ' + (p.descricao || '')
    );
  }

  // Controles de busca
  window.addEventListener('DOMContentLoaded', () => {
    const campoBusca = document.getElementById('buscaAdmin');
    const btnBuscar = document.getElementById('btnBuscarAdmin');
    const btnLimpar = document.getElementById('btnLimparBusca');

    if (btnBuscar && campoBusca) {
      btnBuscar.addEventListener('click', () => {
        carregarAdmin(campoBusca.value);
      });
    }

    if (btnLimpar && campoBusca) {
      btnLimpar.addEventListener('click', () => {
        campoBusca.value = '';
        carregarAdmin('');
      });
    }

    // carrega lista inicial
    carregarAdmin('');
  });
  </script>

  <footer class="site-footer">
    <p>&copy; Stopeças 2025</p>
  </footer>
  
</body>
</html>
